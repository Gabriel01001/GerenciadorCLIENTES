// ==============================================================
//  BACKEND V97 - (MANTIDO E CONFIRMADO)
// ==============================================================

function doGet(e) {
  return ContentService.createTextOutput("âœ… API V97 Online!").setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName("Usuarios");
    if (!sheet) sheet = ss.getSheets()[0];

    if (!e || !e.postData) return outputJSON({ success: false, msg: "Erro de acesso." });

    var dados = JSON.parse(e.postData.contents);
    var action = dados.action;
    var scriptProps = PropertiesService.getScriptProperties();
    var C = { USER: 0, PASS: 1, DATE: 2, WA: 3, VAL: 4, CARGO: 5, PIX: 6, STAT: 7, CRIA: 8, MSG_TEMPLATE: 9 };

    if (action == "login") {
      var user = String(dados.user).toLowerCase().trim();
      var pass = String(dados.pass).trim();
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        if (!data[i][C.USER]) continue;
        if (String(data[i][C.USER]).toLowerCase().trim() == user && String(data[i][C.PASS]).trim() == pass) {
          if (String(data[i][C.STAT]).toLowerCase().includes("bloq")) return outputJSON({ success: false, msg: "Conta Bloqueada." });
          var cargo = String(data[i][C.CARGO]);
          var displayDate = (cargo.toLowerCase().includes('admin')) ? "VitalÃ­cio" : formatarDataSafe(data[i][C.DATE]);
          var secs = 0;
          if (cargo === 'Teste') {
             var now = new Date(); var fim = parseData(data[i][C.DATE]);
             if (fim) { secs = Math.floor((fim - now)/1000); if(secs <= 0) return outputJSON({success:false, msg:"Teste expirou"}); displayDate = "Teste (1h)"; }
          }
          var fileKey = (cargo === 'Teste') ? 'FILE_DATA_TESTE' : 'FILE_DATA_GERAL';
          var fileData = JSON.parse(scriptProps.getProperty(fileKey) || "{}");
          var msgGlobal = scriptProps.getProperty('GLOBAL_MSG') || "";
          var userTmpl = data[i][C.MSG_TEMPLATE]; 
          if (!userTmpl || String(userTmpl).trim() === "") {
              userTmpl = "OlÃ¡ {nome}! ðŸ‘‹\n\nPassando para lembrar do vencimento do seu acesso *{servidor}*.\n\nðŸ—“ï¸ Vencimento: *{vencimento}*\nðŸ’° Valor: *R$ {valor}*\n\nPodemos renovar? ðŸš€";
          }
          var userData = {
            user: data[i][C.USER], pass: data[i][C.PASS], date: displayDate,
            wa: data[i][C.WA], val: data[i][C.VAL], cargo: cargo, pix: data[i][C.PIX],
            isMaster: cargo.toLowerCase().includes('admin'),
            testSeconds: secs,
            file: fileData,
            message: msgGlobal,
            waTemplate: userTmpl
          };
          return outputJSON({ success: true, data: userData });
        }
      }
      return outputJSON({ success: false, msg: "Dados incorretos." });
    }

    if (action == "save_wa_template") {
        var user = String(dados.user).toLowerCase();
        var rows = sheet.getDataRange().getValues();
        for (var i = 1; i < rows.length; i++) {
            if (String(rows[i][C.USER]).toLowerCase() === user) {
                sheet.getRange(i + 1, 10).setValue(dados.template);
                return outputJSON({ success: true });
            }
        }
        return outputJSON({ success: false, msg: "UsuÃ¡rio nÃ£o encontrado." });
    }

    if (action == "admin_list") {
      if (!verificarAdmin(sheet, C, dados.user, dados.pass)) return outputJSON({success:false, msg: "Auth falhou"});
      var rows = sheet.getDataRange().getValues();
      var list = [];
      var reqUser = String(dados.user).toLowerCase();
      var reqCargo = getCargo(sheet, C, reqUser).toLowerCase();
      for (var i = 1; i < rows.length; i++) {
        if (!rows[i][C.USER] || String(rows[i][C.USER]) === "") continue;
        try {
            var u = String(rows[i][C.USER]).toLowerCase();
            var criador = String(rows[i][C.CRIA] || "").toLowerCase();
            rows[i][C.DATE] = formatarDataSafe(rows[i][C.DATE]);
            if (reqCargo === 'admin' && !reqCargo.includes('sub')) { list.push(rows[i]); } 
            else if (reqCargo.includes('sub') || reqCargo.includes('admin')) { if (criador === reqUser || u === reqUser) list.push(rows[i]); }
        } catch (errLoop) { continue; }
      }
      return outputJSON({ success: true, list: list, headers: rows[0] });
    }

    if (action == "create_user") {
      if (!verificarAdmin(sheet, C, dados.user, dados.pass)) return outputJSON({success:false});
      var n = dados.novoUsuario;
      var dataFim = n.date;
      if (n.cargo === 'Teste') { var h = new Date(); h.setHours(h.getHours()+1); dataFim = formatarFull(h); }
      sheet.appendRow([n.user, n.pass, dataFim, n.wa, n.val, n.cargo, n.pix, "Ativo", dados.user, ""]);
      return outputJSON({ success: true });
    }
    if (action == "edit_user") { if (!verificarAdmin(sheet, C, dados.user, dados.pass)) return outputJSON({success:false}); var r = findRow(sheet, C, dados.dadosEditados.userOriginal); if (r > 0) { var e = dados.dadosEditados; var reqCargo = getCargo(sheet, C, dados.user).toLowerCase(); if(e.cargo && reqCargo === 'admin' && !reqCargo.includes('sub')) sheet.getRange(r, C.CARGO+1).setValue(e.cargo); if(e.pass) sheet.getRange(r, C.PASS+1).setValue(e.pass); sheet.getRange(r, C.DATE+1).setValue(e.date); sheet.getRange(r, C.WA+1).setValue(e.wa); sheet.getRange(r, C.VAL+1).setValue(e.val); return outputJSON({ success: true }); } return outputJSON({success:false}); }
    if (action == "renew_user") { if (!verificarAdmin(sheet, C, dados.user, dados.pass)) return outputJSON({success:false}); var r = findRow(sheet, C, dados.targetUser); if (r > 0) { var d = new Date(); d.setDate(d.getDate() + parseInt(dados.days)); sheet.getRange(r, C.DATE+1).setValue(formatarDataSafe(d)); sheet.getRange(r, C.STAT+1).setValue("Ativo"); return outputJSON({ success: true }); } return outputJSON({success:false}); }
    if (action == "toggle_status") { if (!verificarAdmin(sheet, C, dados.user, dados.pass)) return outputJSON({success:false}); var r = findRow(sheet, C, dados.targetUser); if (r > 0) { var c = sheet.getRange(r, C.STAT+1); c.setValue(String(c.getValue()).includes("Ativo") ? "Bloqueado" : "Ativo"); return outputJSON({ success: true, novoStatus: c.getValue() }); } return outputJSON({success:false}); }

    if (action == "save_client") { var sheetCli = ss.getSheetByName("Clientes"); if (!sheetCli) { sheetCli = ss.insertSheet("Clientes"); sheetCli.appendRow(["ID", "Criador", "Nome", "Usuario", "Servidor", "Whatsapp", "Valor", "Vencimento", "Data Cadastro"]); } var id = new Date().getTime().toString(); var criador = dados.user; var n = dados.cliente; var hoje = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy"); sheetCli.appendRow([id, criador, n.nome, n.usuario, n.servidor, "'" + n.whatsapp, n.valor, n.vencimento, hoje]); return outputJSON({ success: true }); }
    if (action == "edit_client") { var sheetCli = ss.getSheetByName("Clientes"); if (!sheetCli) return outputJSON({ success: false }); var rows = sheetCli.getDataRange().getValues(); var n = dados.cliente; var encontrado = false; for (var i = 1; i < rows.length; i++) { if (String(rows[i][0]) == String(n.id)) { var r = i + 1; sheetCli.getRange(r, 3).setValue(n.nome); sheetCli.getRange(r, 4).setValue(n.usuario); sheetCli.getRange(r, 5).setValue(n.servidor); sheetCli.getRange(r, 6).setValue("'" + n.whatsapp); sheetCli.getRange(r, 7).setValue(n.valor); sheetCli.getRange(r, 8).setValue(n.vencimento); encontrado = true; break; } } return outputJSON({ success: encontrado }); }
    if (action == "list_clients") { var sheetCli = ss.getSheetByName("Clientes"); if (!sheetCli) return outputJSON({ success: true, lista: [] }); var rows = sheetCli.getDataRange().getValues(); rows.shift(); var cargoLogado = getCargo(sheet, C, dados.user).toLowerCase(); var userLogado = String(dados.user).toLowerCase(); var listaFinal = []; for (var i = 0; i < rows.length; i++) { var r = rows[i]; var criadorCliente = String(r[1]).toLowerCase(); var vencFormatado = formatarDataSafe(r[7]); var cadastroFormatado = formatarDataSafe(r[8]); var podeVer = false; if (cargoLogado === 'admin' && !cargoLogado.includes('sub')) { podeVer = true; } else { if (criadorCliente === userLogado) { podeVer = true; } } if (podeVer) { listaFinal.push({ id: r[0], criador: r[1], nome: r[2], usuario: r[3], servidor: r[4], whatsapp: r[5], valor: r[6], vencimento: vencFormatado, data: cadastroFormatado }); } } return outputJSON({ success: true, lista: listaFinal }); }
    if (action == "delete_client") { var sheetCli = ss.getSheetByName("Clientes"); if (!sheetCli) return outputJSON({ success: false }); var rows = sheetCli.getDataRange().getValues(); for (var i = 0; i < rows.length; i++) { if (String(rows[i][0]) == String(dados.id)) { sheetCli.deleteRow(i + 1); return outputJSON({ success: true }); } } return outputJSON({ success: false, msg: "Cliente nÃ£o encontrado." }); }

    if (action == "upload_file") { try { var folder = DriveApp.getFoldersByName("ZapFlow_Arquivos").hasNext() ? DriveApp.getFoldersByName("ZapFlow_Arquivos").next() : DriveApp.createFolder("ZapFlow_Arquivos"); var blob = Utilities.newBlob(Utilities.base64Decode(dados.fileData), dados.fileType, dados.fileName); var file = folder.createFile(blob); file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); var key = (dados.mode === 'teste') ? 'FILE_DATA_TESTE' : 'FILE_DATA_GERAL'; scriptProps.setProperty(key, JSON.stringify({ url: file.getDownloadUrl(), time: new Date().toLocaleString("pt-BR"), name: dados.fileName })); return outputJSON({ success: true, url: file.getDownloadUrl() }); } catch(e) { return outputJSON({success:false, msg:"Erro Drive"}); } }
    if (action == "get_tutorials") return outputJSON({ success: true, list: JSON.parse(scriptProps.getProperty('TUTORIALS_DATA')||"[]") });
    if (action == "save_tutorial") { var l = JSON.parse(scriptProps.getProperty('TUTORIALS_DATA')||"[]"); l.push({ title: dados.title, link: dados.link, id: new Date().getTime() }); scriptProps.setProperty('TUTORIALS_DATA', JSON.stringify(l)); return outputJSON({ success: true }); }
    if (action == "delete_tutorial") { var l = JSON.parse(scriptProps.getProperty('TUTORIALS_DATA')||"[]"); var n = l.filter(function(i){return i.id != dados.id}); scriptProps.setProperty('TUTORIALS_DATA', JSON.stringify(n)); return outputJSON({ success: true }); }
    if (action == "save_message") { scriptProps.setProperty('GLOBAL_MSG', dados.message); return outputJSON({success:true}); }

    return outputJSON({ success: false, msg: "Comando invÃ¡lido." });
  } catch (err) { return outputJSON({ success: false, msg: "ERRO GERAL: " + err.toString() }); } finally { lock.releaseLock(); }
}

function outputJSON(d) { return ContentService.createTextOutput(JSON.stringify(d)).setMimeType(ContentService.MimeType.JSON); }
function parseData(v) { if(!v)return null; if(v instanceof Date)return v; if(typeof v==='string'){var p=v.split('/'); if(p.length===3)return new Date(p[2],p[1]-1,p[0]); var s=v.split(' '); if(s.length>1){var d=s[0].split('/'); var t=s[1].split(':'); return new Date(d[2],d[1]-1,d[0],t[0],t[1]);}} return new Date(v); }
function formatarDataSafe(v) { if(!v) return "-"; try { var d=parseData(v); if(!d||isNaN(d.getTime())) return String(v); var dd=("0"+d.getDate()).slice(-2),mm=("0"+(d.getMonth()+1)).slice(-2),yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; } catch(e) { return String(v); } }
function formatarFull(d) { var dd=("0"+d.getDate()).slice(-2),mm=("0"+(d.getMonth()+1)).slice(-2),yy=d.getFullYear(),hh=("0"+d.getHours()).slice(-2),mi=("0"+d.getMinutes()).slice(-2); return `${dd}/${mm}/${yy} ${hh}:${mi}`; }
function verificarAdmin(s,c,u,p){var d=s.getDataRange().getValues(); for(var i=1;i<d.length;i++) { if(!d[i][c.USER]) continue; if(String(d[i][c.USER]).toLowerCase()==String(u).toLowerCase()&&String(d[i][c.PASS])==String(p))return true; } return false;}
function getCargo(s,c,u){var d=s.getDataRange().getValues(); for(var i=1;i<d.length;i++) { if(!d[i][c.USER]) continue; if(String(d[i][c.USER]).toLowerCase()==String(u).toLowerCase()) return String(d[i][c.CARGO]); } return "User"; }
function findRow(s,c,u){var d=s.getDataRange().getValues(); for(var i=1;i<d.length;i++) { if(!d[i][c.USER]) continue; if(String(d[i][c.USER]).toLowerCase()==String(u).toLowerCase()) return i+1; } return -1; }
