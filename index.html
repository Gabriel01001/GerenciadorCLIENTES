<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador |WA|</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%2310b981%22/><text x=%2250%22 y=%2250%22 font-size=%2260%22 text-anchor=%22middle%22 dy=%22.35em%22>‚ö°</text></svg>">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --dark: #064e3b; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --card: #fff; --radius: 12px; --blue: #3b82f6; --gold: #f59e0b; --gray: #6b7280; --purple: #8b5cf6; }
        body.dark-mode { --bg: #111827; --text: #f9fafb; --card: #1f2937; }
        * { box-sizing: border-box; } 
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; transition: 0.3s; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e5e7eb; border-radius: var(--radius); font-family: inherit; background: #f9fafb; color: #333; font-size: 14px; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #374151; color: white; border-color: #4b5563; }
        button { width: 100%; padding: 12px; border: none; border-radius: var(--radius); background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        button:hover { filter: brightness(0.9); transform: translateY(-1px); }
        button.secondary { background: #e5e7eb; color: #333; }
        button.danger { background: var(--danger); }
        button.edit-btn { background: #3b82f6; color: white; }
        button.status-btn { background: var(--gold); color: white; border: 1px solid #d97706; }
        button.test-btn { background: #8b5cf6; color: white; }
        button.admin-btn { background: var(--text); color: var(--card); }
        button.chat-btn { background: #25d366; color: white; }
        button.renew-btn { background: #8b5cf6; color: white; }
        button.vip-btn { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .btn-auto { width: auto !important; padding: 8px 16px; font-size: 13px; margin: 3px; flex-shrink: 0; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .menu-card { background: var(--bg); border: 2px solid #e5e7eb; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 120px; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); background: rgba(16, 185, 129, 0.05); }
        .menu-icon { font-size: 40px; margin-bottom: 10px; }
        .menu-title { font-weight: 700; font-size: 14px; color: var(--text); }
        .tutorial-btn-orange { background: linear-gradient(135deg, #fb923c, #ea580c); color: white; border: none; padding: 8px 20px; font-size: 12px; border-radius: 25px; box-shadow: 0 4px 10px rgba(234, 88, 12, 0.4); transition: 0.3s; display: inline-flex; align-items: center; gap: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .tutorial-btn-orange:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 15px rgba(234, 88, 12, 0.6); filter: brightness(1.1); }
        .autoresponder-btn { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 5px 15px; font-size: 12px; border-radius: 15px; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); transition: 0.3s; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 2px; line-height: 1.2; }
        .autoresponder-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 15px rgba(79, 70, 229, 0.6); filter: brightness(1.1); }
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card { background: var(--card); border: 1px solid #e5e7eb; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; border-radius: var(--radius); align-items: center; gap: 10px; overflow: hidden; }
        .link-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; min-width: 0; word-break: break-all; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(4px); padding: 20px; }
        .modal-overlay.show { display:flex; }
        .modal-content { background:var(--card); padding: 20px; border-radius:20px; width: 100%; max-width: 400px; position:relative; color: var(--text); max-height: 80vh; overflow-y: auto; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        @media (min-width: 768px) { #modal-admin .modal-content { max-width: 1400px; width: 98%; } }
        .admin-action-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .admin-toggle-btn { padding: 10px; font-size: 11px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s; }
        .section-orange { background: #f97316; } .section-blue { background: #3b82f6; } .section-green { background: #16a34a; }
        .admin-section-hidden { display: none; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .pay-card { text-align: center; border: 2px solid #10b981; border-radius: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); margin-bottom: 15px; }
        .pay-key { font-family: monospace; font-size: 13px; background: var(--bg); padding: 10px; border-radius: 8px; border: 1px dashed #ccc; margin: 15px 0; word-break: break-all; }
        .table-responsive { overflow-x: auto; border: 1px solid #eee; border-radius: 10px; margin-top: 10px; min-height: 250px; padding-bottom: 80px; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 700px; }
        .admin-table th { background: #f3f4f6; color: #374151; padding: 12px; text-align: center !important; font-weight: 700; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        .admin-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; white-space: nowrap; text-align: center !important; }
        .admin-table tr:hover { background: rgba(0,0,0,0.02); }
        .col-extra { display: none; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-active { background-color: #10b981; } .status-expired { background-color: #ef4444; } .status-pending { background-color: #f59e0b; } .status-test { background-color: #06b6d4; box-shadow: 0 0 6px #06b6d4; }
        .theme-toggle { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; padding: 0; background: var(--primary); color: white; border: none; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 24px; }
        .save-prompt { background: #eff6ff; color: #1e40af; padding: 10px; border-radius: var(--radius); border: 1px dashed #3b82f6; margin-top: 10px; display: none; align-items: center; justify-content: space-between; gap: 8px; }
        .pagination-ctrl { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; margin-bottom: 20px; font-size: 13px; }
        .loader { border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 2; }
        .discarded-section { margin-top: 30px; border-top: 2px dashed #e5e7eb; padding-top: 20px; }
        .card-discarded { border-left: 4px solid var(--gray); opacity: 0.8; }
        .msg-box { min-height: 60px; resize: vertical; margin-bottom: 15px; }
        .tutorial-step { text-align: left; margin-bottom: 15px; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 10px; font-size: 13px; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 10px; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .timer-badge { background: #ef4444; color: white; padding: 2px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-left: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .custom-table { width: 100%; border-collapse: collapse; font-size: 13px; background: var(--card); border-radius: 10px; overflow: visible !important; }
        .custom-table thead { background: var(--bg); border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; z-index: 50; }
        .custom-table th { padding: 12px; text-align: left; color: var(--primary); font-weight: 700; cursor: pointer; position: relative; }
        .custom-table th:hover { background: rgba(0,0,0,0.05); }
        .custom-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; color: var(--text); }
        .custom-table tr:hover { background: rgba(0,0,0,0.02); }
        .wa-link { color: #25d366; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 4px; border: 1px solid #25d366; padding: 3px 8px; border-radius: 20px; font-size: 11px; width: fit-content; background:transparent; cursor:pointer;}
        .wa-link:hover { background: #f0fdf4; }
        .alert-icon { color: #ef4444; font-size: 14px; animation: pulse 1s infinite; margin-left: 5px; }
        
        .filter-dropdown { position: absolute; top: 35px; left: 0; background: var(--card); border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 12px; z-index: 9999; min-width: 200px; text-align: left !important; display: none; }
        .filter-dropdown.show { display: block; }
        .filter-content { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .filter-option { display: flex !important; align-items: center; gap: 8px; font-size: 12px; color: var(--text); cursor: pointer; white-space: nowrap; padding: 4px; border-radius: 4px; width: 100%; }
        .filter-option:hover { background: rgba(0,0,0,0.05); }
        .filter-option input { width: 14px; height: 14px; margin: 0; cursor: pointer; }
        .filter-actions { border-top: 1px solid #eee; margin-top: 8px; padding-top: 8px; text-align: right; }
        .filter-btn-small { font-size: 10px; padding: 4px 10px; background: var(--text); color: var(--card); border-radius: 4px; width: auto; display: inline-block; cursor: pointer;}

        @media (max-width: 600px) {
            .custom-table, .custom-table thead, .custom-table tbody, .custom-table th, .custom-table td, .custom-table tr { display: block; }
            .custom-table thead tr { position: absolute; top: -9999px; left: -9999px; }
            .custom-table tr { border: 1px solid #eee; border-radius: 10px; margin-bottom: 10px; background: var(--card); position: relative; }
            .custom-table td { position: relative; padding-left: 50%; border: none; border-bottom: 1px solid #eee; }
            .custom-table td:before { position: absolute; top: 12px; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: bold; content: attr(data-label); color: var(--gray); }
        }
    </style>
</head>
<body>

    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

    <div class="container">
        <div id="login-screen" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <div style="background: var(--primary); width: 60px; height: 60px; border-radius: 15px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white;">‚ö°</div>
            <h2 style="font-weight: 700;">Gerenciador <span>|WA|</span></h2>
            <input type="text" id="user" placeholder="Usu√°rio">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="conectarBanco()" id="btn-login"><span id="txt-login">Entrar</span><div class="loader" id="loader-login"></div></button>
            <p id="msg-login" style="color: red; font-size: 14px; margin-top: 10px; font-weight: 600;"></p>
            <button onclick="window.open('https://wa.me/5521970458286')" class="secondary btn-auto" style="margin-top:20px;">üí¨ Suporte T√©cnico</button>
            <div style="margin-top: 40px; font-size: 11px; opacity: 0.6; color: var(--text);"><p style="margin:0;">&copy; 2026 Gerenciador |WA|</p><p style="margin:2px 0 0 0;">Dev: <b>Gabriel Martins</b></p></div>
        </div>

        <div id="dashboard-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="ola-dashboard" style="margin:0; font-size:20px;">Ol√°, Usu√°rio</h3>
                <button onclick="logout()" class="danger btn-auto">Sair</button>
            </div>
            <small id="status-dashboard" style="display:block; margin-bottom:20px; color:var(--primary); font-weight:bold;"></small>
            <div class="dashboard-grid">
                <div class="menu-card" onclick="abrirZapFlow()"><div class="menu-icon">‚ö°</div><div class="menu-title">Gerenciador Links</div></div>
                <div class="menu-card" onclick="abrirClientes()"><div class="menu-icon">üë•</div><div class="menu-title">Gest√£o Clientes</div></div>
            </div>
            <button id="btn-open-admin-dash" class="admin-btn hidden" style="margin-top:20px;" onclick="abrirAdminPanel()">‚öôÔ∏è Painel Master</button>
        </div>

        <div id="app-screen" class="hidden">
            <div class="header">
                <div style="display:flex; gap:10px; align-items:center;"><button class="secondary btn-auto" onclick="voltarDashboard()">‚¨Ö Voltar</button><h3 style="margin:0;">Gerenciador Links</h3></div>
                <div style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:5px; justify-content: flex-end;">
                    <button class="tutorial-btn-orange btn-auto" onclick="abrirTutoriais()">üì∫ Tutoriais</button>
                    <button id="btn-autoresponder" class="autoresponder-btn btn-auto" onclick="window.open('https://drive.google.com/file/d/1KALRwBkxEqhymjNdxqlalBYsdAXH95zB/view?usp=sharing')"><div style="font-weight:700; font-size:13px;">‚¨á Baixar</div><div style="font-size:10px; opacity:0.9; font-weight:400;">Auto responde</div></button>
                </div>
            </div>
            <div id="file-download-card" class="card" style="background: #eff6ff; border: 1px solid #bfdbfe; display: none; color: #1f2937 !important;">
                <div style="display: flex; align-items: center; gap: 10px; overflow: hidden;"><span style="font-size: 24px;">üì•</span><div style="overflow: hidden;"><div style="font-weight: bold; font-size: 14px; color: #1f2937;" id="file-title">Arquivo</div><div style="font-size: 11px; color: #4b5563; white-space: nowrap;">Atualizado: <span id="file-date"></span></div></div></div>
                <button id="btn-download-file" onclick="baixarArquivoGeral()" class="btn-auto" style="background: #3b82f6;">Baixar</button>
            </div>
            <div id="vencimento-alert" class="card" style="background: #fff7ed; border: 1px solid #fdba74; display: none; margin-bottom: 20px; padding: 15px;">
                <div style="display:flex; align-items:center; gap:5px; justify-content: space-between; width: 100%;"><span style="color:#333; font-size: 12px;">‚ö†Ô∏è Expira em <span id="dias-restantes-alerta" style="font-weight: bold;">0</span> dias.</span><button onclick="abrirModalRenovar()" class="vip-btn btn-auto">Renovar</button></div>
            </div>
            <div style="background: rgba(0,0,0,0.03); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <h4 style="margin: 0 0 10px 0;">üì• Adicionar Dados</h4>
                <textarea id="links-input" rows="1" placeholder="Cole links ou n√∫meros..."></textarea>
                <div style="display: flex; gap: 8px;"><button onclick="addLinks()" class="btn-auto">Carregar</button><button onclick="document.getElementById('file').click()" class="secondary btn-auto">üìÇ Arquivo</button><input type="file" id="file" accept=".txt" hidden onchange="lerArquivo(this)"></div>
                <div id="save-prompt" class="save-prompt"><div style="overflow: hidden; flex: 1;"><span style="font-size: 12px; font-weight: bold;">Salvar anterior?</span><div id="last-link-opened" style="font-size: 10px; opacity: 0.7; overflow: hidden; text-overflow: ellipsis;"></div></div><div style="display: flex; gap: 6px;"><button onclick="confirmarSalvamento(true)" class="btn-auto" style="padding: 6px 12px;">Sim</button><button onclick="confirmarSalvamento(false)" class="secondary btn-auto" style="padding: 6px 12px;">N√£o</button></div></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><h4 style="color: var(--primary); margin:0;">Pendentes (<span id="count-pend">0</span>)</h4><button onclick="limparPendentes()" class="danger btn-auto" style="padding: 6px 12px; font-size: 11px;">üóëÔ∏è Limpar</button></div>
            <div id="lista-pendentes"></div><div id="paginacao-pend" class="pagination-ctrl"></div>
            <h4 style="color: var(--blue);">Salvos (<span id="count-saved">0</span>)</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;"><button onclick="baixarSalvos()" class="secondary btn-auto">üì• Extrair</button><button onclick="document.getElementById('file-saved').click()" class="secondary btn-auto">üìÇ Arquivo</button><input type="file" id="file-saved" accept=".txt" hidden onchange="lerArquivoSalvos(this)"><button onclick="limparSalvos()" class="danger btn-auto">üóëÔ∏è Limpar</button></div>
            <div id="lista-salvos"></div><div id="paginacao-salv" class="pagination-ctrl"></div>
            <div class="discarded-section"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><h4 style="color: var(--gray); margin:0;">N√£o Salvos (<span id="count-discarded">0</span>)</h4><button onclick="limparDescartados()" class="danger btn-auto" style="padding: 6px 12px; font-size: 11px;">üóëÔ∏è Limpar</button></div><div id="lista-descartados"></div><div id="paginacao-desc" class="pagination-ctrl"></div></div>
        </div>

        <div id="clients-screen" class="hidden">
            <div class="header">
                <div style="display:flex; gap:10px; align-items:center;"><button class="secondary btn-auto" onclick="voltarDashboard()">‚¨Ö Voltar</button><h3 style="margin:0;">Gest√£o Clientes</h3></div>
                <div style="display:flex; gap:5px;">
                    <button class="secondary btn-auto" onclick="abrirConfigMsg()">‚öôÔ∏è Msg</button>
                    <button class="chat-btn btn-auto" onclick="abrirModalCliente()">‚ûï Novo</button>
                </div>
            </div>
            <input type="text" id="search-client" placeholder="üîç Buscar por nome, usu√°rio, criador..." onkeyup="filtrarClientesUI()" style="margin-bottom:15px;">
            
            <div class="table-responsive" style="min-height: 300px;">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th onclick="tabelaSort('nome')">Nome ‚Üï</th>
                            
                            <th id="th-criador" style="display:none;" onclick="toggleFilter(event, 'criador')">
                                Criador ‚ñæ 
                                <div id="filter-criador" class="filter-dropdown">
                                    <div class="filter-content"></div>
                                    <div class="filter-actions"><button class="secondary filter-btn-small" onclick="limparFiltro('criador')">Limpar</button></div>
                                </div>
                            </th>

                            <th onclick="tabelaSort('usuario')">Usu√°rio ‚Üï</th>
                            
                            <th onclick="toggleFilter(event, 'servidor')">
                                Servidor ‚ñæ 
                                <div id="filter-servidor" class="filter-dropdown">
                                    <div class="filter-content"></div>
                                    <div class="filter-actions"><button class="secondary filter-btn-small" onclick="limparFiltro('servidor')">Limpar</button></div>
                                </div>
                            </th>

                            <th onclick="tabelaSort('whatsapp')">WhatsApp ‚Üï</th>
                            
                            <th onclick="toggleFilter(event, 'vencimento')">
                                Vencimento ‚ñæ 
                                <div id="filter-vencimento" class="filter-dropdown">
                                    <div class="filter-content"></div>
                                    <div class="filter-actions"><button class="secondary filter-btn-small" onclick="limparFiltro('vencimento')">Limpar</button></div>
                                </div>
                            </th>

                            <th onclick="toggleFilter(event, 'valor')">
                                Valor ‚ñæ 
                                <div id="filter-valor" class="filter-dropdown">
                                    <div class="filter-content"></div>
                                    <div class="filter-actions"><button class="secondary filter-btn-small" onclick="limparFiltro('valor')">Limpar</button></div>
                                </div>
                            </th>

                            <th style="width: 100px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-corpo">
                        </tbody>
                </table>
                <div id="loader-clientes" class="loader" style="display:none; border-color:#ccc; border-top-color:#333; margin-top:20px;"></div>
                <p id="msg-sem-clientes" style="text-align:center; opacity:0.6; margin-top:20px; display:none;">Nenhum cliente encontrado.</p>
            </div>
        </div>
    </div>

    <div id="modal-new-client" class="modal-overlay" style="z-index: 1005;">
        <div class="modal-content" style="max-width: 350px;">
            <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000;" onclick="fecharModal('modal-new-client')">&times;</span>
            <h3 id="modal-cli-title" style="margin-top:0; color:var(--primary);">Novo Cliente</h3>
            <input type="text" id="cli-nome" placeholder="Nome do Cliente">
            <input type="text" id="cli-user" placeholder="Usu√°rio/Login">
            <input type="text" id="cli-server" placeholder="Servidor">
            <input type="text" id="cli-wa" placeholder="WhatsApp (s√≥ n√∫meros)">
            <input type="text" id="cli-val" placeholder="Valor (ex: 20,00)">
            <label style="display:block; text-align:left; font-size:12px; font-weight:bold; margin-bottom:5px; color:#333;">Data de Vencimento:</label>
            <input type="date" id="cli-venc">
            <button onclick="salvarCliente()" id="btn-save-cli" style="margin-top:15px;">üíæ Salvar Cliente</button>
        </div>
    </div>

    <div id="modal-config-msg" class="modal-overlay" style="z-index: 1006;">
        <div class="modal-content" style="max-width: 400px;">
            <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000;" onclick="fecharModal('modal-config-msg')">&times;</span>
            <h3 style="margin-top:0; color:var(--primary);">Configurar Mensagem</h3>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">Use: {nome}, {usuario}, {servidor}, {valor}, {vencimento}</p>
            <textarea id="config-msg-input" class="msg-box" style="height:120px;"></textarea>
            <button onclick="salvarTemplateMsg()">üíæ Salvar Padr√£o</button>
        </div>
    </div>

    <div id="modal-send-charge" class="modal-overlay" style="z-index: 1007;">
        <div class="modal-content" style="max-width: 400px;">
            <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000;" onclick="fecharModal('modal-send-charge')">&times;</span>
            <h3 style="margin-top:0; color:#25d366;">Enviar Cobran√ßa</h3>
            <textarea id="msg-final-charge" class="msg-box" style="height:150px;"></textarea>
            <input type="hidden" id="wa-dest-charge">
            <button onclick="enviarCobrancaReal()" class="chat-btn">üöÄ Enviar WhatsApp</button>
        </div>
    </div>

    <div id="modal-admin" class="modal-overlay"><div class="modal-content"><span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000; font-weight:bold; color:var(--text);" onclick="fecharModal('modal-admin')">&times;</span><div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:15px;"><h2 style="color: var(--dark); font-size: 20px; margin:0;">‚öôÔ∏è Gest√£o Master</h2><div style="display:flex; gap:8px;"><button class="secondary btn-auto" onclick="abrirAdminPanel()">üîÑ</button><button class="chat-btn btn-auto" onclick="abrirModalCreate()">‚ûï Novo</button></div></div><div class="admin-action-bar"><button class="admin-toggle-btn section-orange" onclick="toggleAdminSection('admin-msg-area')"><span style="font-size:18px">üîî</span> Aviso</button><button class="admin-toggle-btn section-blue" onclick="toggleAdminSection('upload-section-geral')"><span style="font-size:18px">üìÅ</span> Geral</button><button class="admin-toggle-btn section-green" onclick="toggleAdminSection('upload-section-teste')"><span style="font-size:18px">üß™</span> Teste</button></div><div id="admin-msg-area" class="admin-section-hidden" style="background:#fff7ed; border:1px dashed #f97316; padding:15px; border-radius:8px; margin-bottom:10px;"><div style="font-size:12px; font-weight:bold; margin-bottom:8px; color:#c2410c;">üîî Mensagem Global (Popup)</div><textarea id="global-msg-input" rows="2" placeholder="Escreva um aviso para todos os usu√°rios..." style="margin-bottom:5px; font-size:12px;"></textarea><button class="btn-auto" style="background:#f97316; width:100% !important;" onclick="salvarMensagem()">Enviar Aviso</button></div><div id="upload-section-geral" class="admin-section-hidden" style="background:#f9fafb; border:1px dashed #ccc; padding:15px; border-radius:8px; margin-bottom:10px;"><div style="font-size:12px; font-weight:bold; margin-bottom:8px; color:#333;">üìÅ Arquivo OFICIAL (Todos)</div><div style="display:flex; gap:8px;"><input type="file" id="admin-file-upload" style="margin:0; padding:8px; font-size:12px; color:#333; width: 100%;"><button class="btn-auto" onclick="fazerUploadArquivo('geral')">Enviar</button></div></div><div id="upload-section-teste" class="admin-section-hidden" style="background:#f0fdf4; border:1px dashed #16a34a; padding:15px; border-radius:8px; margin-bottom:20px;"><div style="font-size:12px; font-weight:bold; margin-bottom:8px; color:#15803d;">üß™ Arquivo TESTE (Apenas Testes)</div><div style="display:flex; gap:8px;"><input type="file" id="admin-file-test" style="margin:0; padding:8px; font-size:12px; color:#333; width: 100%;"><button class="btn-auto" style="background:#16a34a;" onclick="fazerUploadArquivo('teste')">Enviar</button></div></div><div id="upload-status" style="font-size:11px; color:#666; margin-bottom:10px;"></div><div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;"><input type="checkbox" id="toggle-details" onchange="toggleDetalhes()"><label for="toggle-details" style="font-size:13px; cursor:pointer;">üëÅÔ∏è Mostrar Detalhes (Senha, Pix, etc)</label></div><input type="text" id="search-user" placeholder="üîç Pesquisar usu√°rio..." onkeyup="filtrarUsuarios()" style="margin-bottom: 15px;"><div id="admin-users-list"></div></div></div>
    <div id="modal-create" class="modal-overlay" style="z-index: 1001;"> <div class="modal-content" style="max-width: 400px;"> <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000; font-weight:bold; color:var(--text);" onclick="fecharModal('modal-create')">&times;</span> <h3 style="margin-top:0;">Novo Acesso</h3> <div class="form-grid"> <input type="text" id="new-user" placeholder="Usu√°rio"> <input type="text" id="new-pass" placeholder="Senha"> <div class="full-width" id="days-container" style="display:flex; gap:5px; align-items:center;"><input type="number" id="new-days" placeholder="Dias" style="width: 80px; margin:0"><span style="font-size:12px; color:#666">dias de validade</span></div> <div class="full-width" id="role-container"><label style="font-size:12px; font-weight:bold; color:#333;">Tipo de Acesso:</label><select id="new-role" onchange="checkRole()"></select></div> <input type="text" id="new-wa" placeholder="WhatsApp (s√≥ n√∫meros)" class="full-width"> <input type="text" id="new-val" placeholder="Valor (ex: 30,00)"> <input type="text" id="new-pix" placeholder="Chave PIX (opcional)"> </div> <button onclick="salvarNovoUsuario()" id="btn-save-user" style="margin-top:15px;">üíæ Salvar</button> <p id="msg-create" style="color:red; font-size:12px; text-align:center; margin-top:5px;"></p> </div> </div>
    <div id="modal-edit" class="modal-overlay" style="z-index: 1002;"> <div class="modal-content" style="max-width: 400px;"> <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000; font-weight:bold; color:var(--text);" onclick="fecharModal('modal-edit')">&times;</span> <h3 style="margin-top:0; color:#3b82f6">Editar: <span id="edit-user-display"></span></h3> <div class="form-grid"> <div class="full-width"><label style="font-size:11px; font-weight:bold;">Senha (Deixe vazio para n√£o alterar):</label><input type="text" id="edit-pass" placeholder="Redefinir senha..."></div> <div class="full-width"><label style="font-size:11px; font-weight:bold;">Vencimento:</label><input type="text" id="edit-date" placeholder="DD/MM/AAAA"></div> <div class="full-width"><label style="font-size:11px; font-weight:bold;">WhatsApp:</label><input type="text" id="edit-wa"></div> <div class="full-width"><label style="font-size:11px; font-weight:bold;">Valor:</label><input type="text" id="edit-val"></div> <div class="full-width" id="div-edit-role"><label style="font-size:11px; font-weight:bold;">Fun√ß√£o (Cargo):</label><select id="edit-role"><option value="User">Usu√°rio</option><option value="Teste">Teste</option><option value="Sub-Admin">Sub-Admin</option><option value="Admin">Admin</option></select></div></div> <button onclick="salvarEdicao()" id="btn-save-edit" class="edit-btn" style="margin-top:15px;">üíæ Atualizar Dados</button> <p id="msg-edit" style="color:red; font-size:12px; text-align:center; margin-top:5px;"></p> </div> </div>
    <div id="modal-renovar" class="modal-overlay"> <div class="modal-content" style="max-width: 400px;"> <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000;" onclick="fecharModal('modal-renovar')">&times;</span> <h3 style="text-align: center; color: var(--primary);">üíé Renovar Acesso</h3> <div class="pay-card"> <div style="font-size: 12px; font-weight: bold;">PIX PARA PAGAMENTO</div> <div class="pay-key" id="pix-display" style="font-size:16px; padding:15px;">...</div> </div> <button onclick="copiarPixReal()" class="chat-btn" style="border-radius: 50px; width:100%">üìã Copiar Chave PIX</button> </div> </div>
    <div id="modal-install-tutorial" class="modal-overlay" style="z-index: 9999;"> <div class="modal-content" style="max-width: 350px;"> <div style="text-align:center; margin-bottom:20px;"> <div style="font-size:50px; margin-bottom:10px;">‚ö°</div> <h3 style="margin-top:0; font-size: 20px; font-weight: 700;">Instalar App</h3> <p style="font-size:14px; color: var(--text); line-height: 1.5;">Para a melhor experi√™ncia, adicione este app √† sua tela inicial.</p> </div> <button id="btn-android-install" class="hidden" style="width:100% !important; margin-bottom:15px; font-size: 16px; padding: 15px;" onclick="instalarAndroid()">üì≤ Instalar Agora</button> <div id="tutorial-ios" class="hidden"><div class="tutorial-step">1. Toque no bot√£o <b>Compartilhar</b> <span style="font-size:18px;">‚éã</span> abaixo.</div><div class="tutorial-step">2. Role e selecione <b>Adicionar √† Tela de In√≠cio</b> <span style="font-size:18px;">‚äû</span>.</div></div> <div id="tutorial-android" class="hidden"><div class="tutorial-step">1. Toque nos <b>3 pontinhos</b> <span style="font-size:18px;">‚ãÆ</span> no topo do navegador.</div><div class="tutorial-step">2. Selecione <b>Adicionar √† tela inicial</b> ou <b>Instalar app</b>.</div></div> <button class="secondary btn-auto" style="width:100% !important; margin-top:15px;" onclick="fecharInstallModal()">Agora n√£o</button> </div> </div>
    <div id="modal-global-msg" class="modal-overlay" style="z-index: 1100;"> <div class="modal-content" style="max-width: 400px; text-align: center;"> <div style="font-size: 40px; margin-bottom: 10px;">üîî</div> <h3 style="margin-top:0; color: var(--primary);">Comunicado</h3> <p id="msg-text" style="font-size: 14px; color: #333 !important; background: #f3f4f6; padding: 15px; border-radius: 10px;"></p> <button onclick="marcarMensagemLida()" class="btn-auto" style="margin-top: 15px; width: 100% !important;">Entendi</button> </div> </div>
    <div id="modal-send-whatsapp" class="modal-overlay" style="z-index: 1200;"> <div class="modal-content" style="max-width: 400px;"> <span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000;" onclick="fecharModal('modal-send-whatsapp')">&times;</span> <h3 style="margin-top:0; color: #25d366;">üì≤ Enviar Acesso</h3> <p style="font-size:12px; margin:0 0 10px 0;">Para: <b id="send-dest">...</b></p> <div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:10px; margin-bottom:15px; font-size:12px; color:#166534;"><div style="font-weight:bold; margin-bottom:5px;">üìã Dados que ser√£o enviados:</div><div id="preview-msg-content" style="font-family:monospace; line-height:1.4;"></div></div> <label style="font-size:12px; font-weight:bold;">Mensagem Complementar (Opcional):</label> <textarea id="whatsapp-extra-msg" class="msg-box" placeholder="Ex: 'Aproveite sua tela!', 'Pagamento Confirmado', etc."></textarea> <button class="chat-btn" onclick="finalizarEnvioWhatsApp()">üöÄ Enviar via WhatsApp</button> </div> </div>
    <div id="modal-created-success" class="modal-overlay" style="z-index: 1300;"> <div class="modal-content" style="max-width: 350px; text-align:center;"> <div style="font-size: 50px;">‚úÖ</div> <h3 style="margin-top:0; color:var(--primary);">Usu√°rio Criado!</h3> <p style="font-size:13px; color:#666; margin-bottom:20px;">O que deseja fazer agora?</p> <div style="display:flex; flex-direction:column; gap:10px;"><button class="chat-btn" onclick="prepararEnvioAposCriacao()">üì≤ Enviar Acesso</button><button class="secondary" onclick="fecharModalSucessoCriacao()">‚ùå Fechar</button></div> </div> </div>
    <div id="modal-tutorials" class="modal-overlay" style="z-index: 1500;"><div class="modal-content"><span style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:30px; z-index:1000; font-weight:bold;" onclick="fecharModal('modal-tutorials')">&times;</span><h3 style="margin-top:0; color:var(--primary); font-size: 20px;">üì∫ Central de Ajuda</h3><div id="admin-tutorial-area" style="background:#fff7ed; padding:10px; border-radius:10px; margin-bottom:15px; border:1px dashed #f97316; display:none;"><h4 style="margin:0 0 10px 0; font-size:12px; color:#c2410c;">‚ûï Adicionar V√≠deo (Admin)</h4><input type="text" id="tut-title" placeholder="T√≠tulo do V√≠deo" style="font-size:12px; padding:8px;"><input type="text" id="tut-link" placeholder="Link do YouTube/Drive" style="font-size:12px; padding:8px;"><button onclick="salvarTutorial()" class="btn-auto" style="background:#f97316; width:100% !important;">Salvar V√≠deo</button></div><div id="tutorials-list" style="text-align:left; padding-bottom: 10px;"><p style="text-align:center; color:#666; font-size:13px;">Carregando...</p></div></div></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwtMMYq6gHWUX33Ie05iyjbVKPzWtzd9vebIInLe607nqN57GteOeOGE1a8dMI05Cpw/exec';
        const DB_KEY = 'zapflow_v36'; const SESSION_KEY = 'zapflow_session_v36';
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
        let currentUserData = null; let lastOpenedLink = ""; let pgPend = 0, pgSalv = 0, pgDesc = 0; const ITENS_PAG = 5;
        let autoTimer = null; let countdownRef = null; let userEditing = null; let currentFileUrl = ""; let deferredPrompt; let tempUser="", tempPass="", tempWa="", tempDate="", tempVal=""; let timerInterval = null;
        let listaClientes = []; let clienteEditandoId = null; let globalWhatsappTemplate = "";
        let filtrosAtivos = {}; // { criador: 'Gabriel', servidor: 'ZoomPlay' ... }

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
        window.onload = () => {
            if(localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.querySelector('.theme-toggle').innerText = '‚òÄÔ∏è'; }
            setTimeout(verificarInstalacaoApp, 1000);
            const session = localStorage.getItem(SESSION_KEY);
            if(session) { const s = JSON.parse(session); document.getElementById('user').value = s.user; document.getElementById('pass').value = s.pass; conectarBanco(); }
            
            // Fecha dropdown ao clicar fora
            document.addEventListener('click', (e) => {
                if(!e.target.closest('th')) {
                    document.querySelectorAll('.filter-dropdown').forEach(el => el.classList.remove('show'));
                }
            });
        };

        function abrirZapFlow() { document.getElementById('dashboard-screen').classList.add('hidden'); document.getElementById('clients-screen').classList.add('hidden'); document.getElementById('app-screen').classList.remove('hidden'); }
        function abrirClientes() { document.getElementById('dashboard-screen').classList.add('hidden'); document.getElementById('app-screen').classList.add('hidden'); document.getElementById('clients-screen').classList.remove('hidden'); carregarMeusClientes(); }
        function voltarDashboard() { document.getElementById('app-screen').classList.add('hidden'); document.getElementById('clients-screen').classList.add('hidden'); document.getElementById('dashboard-screen').classList.remove('hidden'); }

        // --- MENSAGEM & COBRAN√áA ---
        function abrirConfigMsg() { document.getElementById('config-msg-input').value = globalWhatsappTemplate; document.getElementById('modal-config-msg').classList.add('show'); }
        async function salvarTemplateMsg() { const tmpl = document.getElementById('config-msg-input').value; if(!tmpl) return alert("Digite algo."); try { const req = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'save_wa_template', user: currentUserData.user, pass: currentUserData.pass, template: tmpl }) }); const res = await req.json(); if(res.success) { globalWhatsappTemplate = tmpl; alert("Modelo salvo!"); fecharModal('modal-config-msg'); } } catch(e) { alert("Erro."); } }
        
        function prepararCobranca(id) {
            const cli = listaClientes.find(c => String(c.id) === String(id));
            if(!cli) { console.error("Cliente nao encontrado", id); return; }
            if(!cli.whatsapp) return alert("Cliente sem WhatsApp.");
            
            if(!globalWhatsappTemplate || globalWhatsappTemplate === "") {
                globalWhatsappTemplate = "Ol√° {nome}! üëã\n\nPassando para lembrar do vencimento do seu acesso *{servidor}*.\n\nüóìÔ∏è Vencimento: *{vencimento}*\nüí∞ Valor: *R$ {valor}*\n\nPodemos renovar? üöÄ";
            }

            let msg = globalWhatsappTemplate;
            msg = msg.replace(/{nome}/g, cli.nome || '').replace(/{usuario}/g, cli.usuario || '').replace(/{servidor}/g, cli.servidor || '').replace(/{valor}/g, cli.valor || '').replace(/{vencimento}/g, cli.vencimento || '');
            document.getElementById('msg-final-charge').value = msg;
            document.getElementById('wa-dest-charge').value = cli.whatsapp.replace(/\D/g,'');
            document.getElementById('modal-send-charge').classList.add('show');
        }
        function enviarCobrancaReal() {
            const num = document.getElementById('wa-dest-charge').value;
            const texto = document.getElementById('msg-final-charge').value;
            window.open(`https://wa.me/55${num}?text=${encodeURIComponent(texto)}`);
            fecharModal('modal-send-charge');
        }

        // --- CLIENTES ---
        function abrirModalCliente() { clienteEditandoId = null; document.getElementById('modal-cli-title').innerText = "Novo Cliente"; document.getElementById('cli-nome').value = ''; document.getElementById('cli-user').value = ''; document.getElementById('cli-server').value = ''; document.getElementById('cli-wa').value = ''; document.getElementById('cli-val').value = ''; document.getElementById('cli-venc').value = ''; document.getElementById('modal-new-client').classList.add('show'); }
        function prepararEdicaoCliente(id) { 
            const cli = listaClientes.find(c => String(c.id) === String(id)); 
            if(!cli) return; 
            clienteEditandoId = id; 
            document.getElementById('modal-cli-title').innerText = "Editar Cliente"; document.getElementById('cli-nome').value = cli.nome; document.getElementById('cli-user').value = cli.usuario; document.getElementById('cli-server').value = cli.servidor; document.getElementById('cli-wa').value = cli.whatsapp ? cli.whatsapp.replace(/\D/g,'') : ''; document.getElementById('cli-val').value = cli.valor; 
            if(cli.vencimento && cli.vencimento.includes('/')) { const parts = cli.vencimento.split('/'); document.getElementById('cli-venc').value = `${parts[2]}-${parts[1]}-${parts[0]}`; } else { document.getElementById('cli-venc').value = ''; } 
            document.getElementById('modal-new-client').classList.add('show'); 
        }
        async function salvarCliente() { const btn = document.getElementById('btn-save-cli'); const nome = document.getElementById('cli-nome').value; const usuario = document.getElementById('cli-user').value; const servidor = document.getElementById('cli-server').value; const whatsapp = document.getElementById('cli-wa').value; const valor = document.getElementById('cli-val').value; const vencInput = document.getElementById('cli-venc').value; if(!nome || !usuario) return alert("Preencha ao menos Nome e Usu√°rio."); let vencFormatado = "-"; if(vencInput) { const partes = vencInput.split('-'); vencFormatado = `${partes[2]}/${partes[1]}/${partes[0]}`; } btn.disabled = true; btn.innerText = "Salvando..."; const payload = { id: clienteEditandoId, nome: nome, usuario: usuario, servidor: servidor, whatsapp: whatsapp, valor: valor, vencimento: vencFormatado }; const acao = clienteEditandoId ? 'edit_client' : 'save_client'; try { const req = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: acao, user: currentUserData.user, pass: currentUserData.pass, cliente: payload }) }); const res = await req.json(); if(res.success) { alert("Salvo!"); fecharModal('modal-new-client'); carregarMeusClientes(); } else { alert("Erro ao salvar."); } } catch(e) { alert("Erro de conex√£o."); } finally { btn.disabled = false; btn.innerText = "üíæ Salvar Cliente"; } }
        async function carregarMeusClientes() { 
            const loader = document.getElementById('loader-clientes');
            const msgEmpty = document.getElementById('msg-sem-clientes');
            const corpo = document.getElementById('tabela-corpo');
            loader.style.display = 'block';
            msgEmpty.style.display = 'none';
            corpo.innerHTML = '';
            
            try { 
                const req = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'list_clients', user: currentUserData.user, pass: currentUserData.pass }) }); 
                const res = await req.json(); 
                if(res.success) { 
                    listaClientes = res.lista; 
                    popularFiltros(); // Atualiza as op√ß√µes dos filtros
                    aplicarFiltrosERenderizar(); 
                } else { 
                    msgEmpty.innerText = "Erro ao carregar."; msgEmpty.style.display = 'block';
                } 
            } catch(e) { 
                msgEmpty.innerText = "Erro de conex√£o."; msgEmpty.style.display = 'block';
            } finally {
                loader.style.display = 'none';
            }
        }
        async function deletarCliente(id) { if(!confirm("Excluir?")) return; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_client', user: currentUserData.user, pass: currentUserData.pass, id: id }) }); carregarMeusClientes(); } catch(e) { alert("Erro."); } }

        // --- SISTEMA DE FILTROS ---
        function toggleFilter(e, campo) {
            e.stopPropagation();
            document.querySelectorAll('.filter-dropdown').forEach(el => {
                if(el.id !== `filter-${campo}`) el.classList.remove('show');
            });
            const menu = document.getElementById(`filter-${campo}`);
            if(menu) menu.classList.toggle('show');
        }

        function popularFiltros() {
            // Popula os checkboxes dinamicamente com base nos dados carregados
            ['criador', 'servidor', 'vencimento', 'valor'].forEach(campo => {
                const contentDiv = document.querySelector(`#filter-${campo} .filter-content`);
                if(!contentDiv) return;
                contentDiv.innerHTML = '';

                if (campo === 'vencimento') {
                    ['Vencidos', 'Expira em 7 dias'].forEach(op => {
                        contentDiv.innerHTML += `<label class="filter-option" onclick="event.stopPropagation()"><input type="checkbox" value="${op}" onchange="atualizarFiltro('${campo}', this)"> ${op}</label>`;
                    });
                } else {
                    const unicos = [...new Set(listaClientes.map(item => item[campo]).filter(Boolean))].sort();
                    if(unicos.length === 0) contentDiv.innerHTML = '<small style="color:#999; padding:5px;">Vazio</small>';
                    unicos.forEach(val => {
                        contentDiv.innerHTML += `<label class="filter-option" onclick="event.stopPropagation()"><input type="checkbox" value="${val}" onchange="atualizarFiltro('${campo}', this)"> ${val}</label>`;
                    });
                }
            });
        }

        function atualizarFiltro(campo, checkbox) {
            if(!filtrosAtivos[campo]) filtrosAtivos[campo] = [];
            if(checkbox.checked) { filtrosAtivos[campo].push(checkbox.value); } else { filtrosAtivos[campo] = filtrosAtivos[campo].filter(v => v !== checkbox.value); }
            aplicarFiltrosERenderizar();
        }

        function limparFiltro(campo) {
            filtrosAtivos[campo] = [];
            // Desmarca checkboxes visuais
            const inputs = document.querySelectorAll(`#filter-${campo} input`);
            inputs.forEach(i => i.checked = false);
            aplicarFiltrosERenderizar();
            document.getElementById(`filter-${campo}`).classList.remove('show');
        }

        function aplicarFiltrosERenderizar() {
            let filtrados = listaClientes.filter(cli => {
                const termo = document.getElementById('search-client').value.toLowerCase();
                if(termo && !JSON.stringify(cli).toLowerCase().includes(termo)) return false;

                for (const [campo, valores] of Object.entries(filtrosAtivos)) {
                    if (valores.length === 0) continue; 
                    if (campo === 'vencimento') {
                        const hoje = new Date(); hoje.setHours(0,0,0,0);
                        let p = cli.vencimento.split('/');
                        let dVenc = new Date(p[2], p[1]-1, p[0]);
                        let diff = (dVenc - hoje) / (1000 * 60 * 60 * 24);
                        let match = false;
                        if(valores.includes('Vencidos') && diff < 0) match = true;
                        if(valores.includes('Expira em 7 dias') && diff >= 0 && diff <= 7) match = true;
                        if(!match) return false;
                    } else {
                        if (!valores.includes(cli[campo])) return false;
                    }
                }
                return true;
            });

            // Ordena√ß√£o Padr√£o: Vencimento Crescente
            filtrados.sort((a,b) => {
                function d(str) { if(!str || str==='-') return new Date(9999,0,1); const p = str.split('/'); return new Date(p[2], p[1]-1, p[0]); }
                return d(a.vencimento) - d(b.vencimento);
            });

            renderizarLinhas(filtrados);
        }

        function filtrarClientesUI() { aplicarFiltrosERenderizar(); } 

        function renderizarLinhas(lista) {
            const corpo = document.getElementById('tabela-corpo');
            const msgEmpty = document.getElementById('msg-sem-clientes');
            corpo.innerHTML = '';
            
            if(lista.length === 0) { 
                msgEmpty.style.display = 'block'; 
                return; 
            } else {
                msgEmpty.style.display = 'none';
            }

            const isAdmin = (currentUserData.cargo === 'Admin' || currentUserData.cargo === 'Sub-Admin');
            const thCriador = document.getElementById('th-criador');
            if(thCriador) thCriador.style.display = isAdmin ? 'table-cell' : 'none';

            const hoje = new Date(); hoje.setHours(0,0,0,0);

            lista.forEach(cli => {
                let waLink = '-';
                if(cli.whatsapp) {
                    waLink = `<button onclick="prepararCobranca('${cli.id}')" class="wa-link">üì± Cobrar</button>`;
                }

                let alerta = "";
                let corVenc = "#333";
                if (cli.vencimento && cli.vencimento.includes('/')) {
                    const parts = cli.vencimento.split('/');
                    const dataVenc = new Date(parts[2], parts[1]-1, parts[0]);
                    const diffDias = (dataVenc - hoje) / (1000 * 60 * 60 * 24);
                    if (diffDias < 0) { alerta = "<span class='alert-icon'>‚ö†</span>"; corVenc = "red"; }
                    else if (diffDias <= 3) { alerta = "<span class='alert-icon'>‚ö†</span>"; corVenc = "#d97706"; }
                }

                let criadorCell = isAdmin ? `<td data-label="Criador" style="color:var(--blue); font-weight:bold;">${cli.criador}</td>` : '';

                corpo.innerHTML += `
                    <tr>
                        <td data-label="Nome"><b>${cli.nome}</b></td>
                        ${criadorCell}
                        <td data-label="Usu√°rio">${cli.usuario}</td>
                        <td data-label="Servidor">${cli.servidor}</td>
                        <td data-label="WhatsApp">${waLink}</td>
                        <td data-label="Vencimento" style="color:${corVenc}; font-weight:bold;">${cli.vencimento || '-'} ${alerta}</td>
                        <td data-label="Valor" style="color:var(--primary); font-weight:bold;">R$ ${cli.valor}</td>
                        <td data-label="A√ß√µes">
                            <div style="display:flex; gap:5px;">
                                <button class="edit-btn btn-auto" style="padding:6px 10px;" onclick="prepararEdicaoCliente('${cli.id}')">‚úèÔ∏è</button>
                                <button class="danger btn-auto" style="padding:6px 10px;" onclick="deletarCliente('${cli.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // --- LEGADO & UTIL ---
        function toggleAdminSection(id) { const el = document.getElementById(id); if (el.style.display === 'block') { el.style.display = 'none'; } else { document.getElementById('admin-msg-area').style.display = 'none'; document.getElementById('upload-section-geral').style.display = 'none'; document.getElementById('upload-section-teste').style.display = 'none'; el.style.display = 'block'; } }
        function verificarInstalacaoApp() { if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) return; const bannerFechadoEm = localStorage.getItem('install_banner_closed'); if (bannerFechadoEm && (new Date().getTime() - parseInt(bannerFechadoEm) < 86400000)) return; abrirTutorialInstall(); }
        function abrirTutorialInstall() { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (deferredPrompt) { document.getElementById('btn-android-install').classList.remove('hidden'); document.getElementById('tutorial-android').classList.add('hidden'); document.getElementById('tutorial-ios').classList.add('hidden'); } else if (isIOS) { document.getElementById('btn-android-install').classList.add('hidden'); document.getElementById('tutorial-ios').classList.remove('hidden'); document.getElementById('tutorial-android').classList.add('hidden'); } else { document.getElementById('btn-android-install').classList.add('hidden'); document.getElementById('tutorial-ios').classList.add('hidden'); document.getElementById('tutorial-android').classList.remove('hidden'); } document.getElementById('modal-install-tutorial').classList.add('show'); }
        async function instalarAndroid() { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') fecharInstallModal(); deferredPrompt = null; } }
        function fecharInstallModal() { document.getElementById('modal-install-tutorial').classList.remove('show'); localStorage.setItem('install_banner_closed', new Date().getTime()); }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); document.querySelector('.theme-toggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô'; }
        function formatarData(d) { if(!d) return new Date(); let l = String(d).trim(); if(l.includes('/')) { const p = l.split('/'); return new Date(p[2], p[1]-1, p[0]); } return new Date(l); }
        function fecharModal(id){ document.getElementById(id).classList.remove('show'); }
        function logout(){ localStorage.removeItem(SESSION_KEY); location.reload(); }
        function lerArquivoSalvos(i) { const r=new FileReader(); r.onload=(e)=>{if(!db[currentUserData.user].salvos) db[currentUserData.user].salvos=[]; const linhas = e.target.result.split('\n'); const novos = linhas.filter(l => l.trim() && !db[currentUserData.user].salvos.includes(l.trim())); db[currentUserData.user].salvos.push(...novos); renderizar();}; r.readAsText(i.files[0]); i.value=''; }
        function tratarAberturaLink(idx, link) { if (lastOpenedLink) { if(!db[currentUserData.user].naoSalvos) db[currentUserData.user].naoSalvos = []; db[currentUserData.user].naoSalvos.push(lastOpenedLink); } lastOpenedLink = link; if(link.includes('http')) { window.open(link); } else { window.open(`whatsapp://send?phone=55${link.replace(/\D/g,'')}`); } db[currentUserData.user].links.splice(idx, 1); document.getElementById('last-link-opened').innerText = link; document.getElementById('save-prompt').style.display = 'flex'; renderizar(); }
        function confirmarSalvamento(sim) { const u = currentUserData.user; if(!db[u].salvos) db[u].salvos=[]; if(!db[u].naoSalvos) db[u].naoSalvos=[]; if(sim && lastOpenedLink) { db[u].salvos.push(lastOpenedLink); } else if (!sim && lastOpenedLink) { db[u].naoSalvos.push(lastOpenedLink); } document.getElementById('save-prompt').style.display = 'none'; lastOpenedLink = ""; renderizar(); }
        function limparPendentes() { if(confirm("Apagar?")) { db[currentUserData.user].links = []; pgPend = 0; renderizar(); } }
        function limparSalvos() { if(confirm("Limpar?")) { db[currentUserData.user].salvos = []; pgSalv = 0; renderizar(); } }
        function limparDescartados() { if(confirm("Limpar?")) { db[currentUserData.user].naoSalvos = []; pgDesc = 0; renderizar(); } }
        function resgatarDescartado(idx) { const u = currentUserData.user; const link = db[u].naoSalvos[idx]; db[u].links.push(link); db[u].naoSalvos.splice(idx, 1); renderizar(); }
        function filtrarUsuarios() { const termo = document.getElementById('search-user').value.toLowerCase(); const linhas = document.querySelectorAll('.admin-table tbody tr'); linhas.forEach(tr => { const texto = tr.innerText.toLowerCase(); tr.style.display = texto.includes(termo) ? '' : 'none'; }); }
        function abrirModalRenovar() { let chave = currentUserData.pix; if (!chave || chave === "undefined") chave = "Chave n√£o cadastrada"; document.getElementById('pix-display').innerText = chave; document.getElementById('modal-renovar').classList.add('show'); }
        function copiarPixReal() { const t = document.getElementById('pix-display').innerText; if(navigator.clipboard) { navigator.clipboard.writeText(t).then(()=>alert("Copiado!")); } else { const el = document.createElement("input"); el.value = t; document.body.appendChild(el); el.select(); document.execCommand("copy"); document.body.removeChild(el); alert("Copiado!"); } }
        function baixarSalvos() { const u = currentUserData.user; if(!db[u].salvos.length) return alert("Nada."); const blob = new Blob([db[u].salvos.join('\n')], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `extraidos.txt`; a.click(); }
        function lerArquivo(i) { const r=new FileReader(); r.onload=(e)=>{ const linhas = e.target.result.split('\n'); processarNovosLinks(linhas); }; r.readAsText(i.files[0]); i.value=''; }
        async function conectarBanco() { const u = document.getElementById('user').value.trim(); const p = document.getElementById('pass').value.trim(); const msg = document.getElementById('msg-login'); const btn = document.getElementById('btn-login'); const txt = document.getElementById('txt-login'); const loader = document.getElementById('loader-login'); if(!u || !p) return msg.innerText = "Preencha todos os campos."; btn.disabled = true; txt.style.display = 'none'; loader.style.display = 'block'; msg.innerText = ""; try { const req = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', user: u, pass: p }) }); const res = await req.json(); if (res.success) { const dados = res.data; let diff = 0; if (dados.cargo !== 'Teste' && dados.date !== 'Vital√≠cio') { const dV = formatarData(dados.date); dV.setHours(0,0,0,0); const hoje = new Date(); hoje.setHours(0,0,0,0); diff = Math.ceil((dV - hoje) / 86400000); if(diff < 0 && !dados.isMaster) { msg.innerText = "Acesso expirado."; localStorage.removeItem(SESSION_KEY); btn.disabled = false; txt.style.display = 'block'; loader.style.display = 'none'; return; } } currentUserData = dados; if(dados.waTemplate) globalWhatsappTemplate = dados.waTemplate; if(dados.pass) { currentUserData.pass = dados.pass; localStorage.setItem(SESSION_KEY, JSON.stringify({user: u, pass: dados.pass})); } else { currentUserData.pass = p; localStorage.setItem(SESSION_KEY, JSON.stringify({user: u, pass: p})); } if(!db[u]) db[u] = {links:[], salvos:[], naoSalvos: []}; document.getElementById('login-screen').classList.add('hidden'); document.getElementById('dashboard-screen').classList.remove('hidden'); document.getElementById('ola-dashboard').innerText = "Ol√°, " + currentUserData.user; document.getElementById('ola-user').innerText = "Ol√°, " + currentUserData.user; if (dados.cargo === 'Teste' && dados.testSeconds) { iniciarTimerTeste(dados.testSeconds); document.getElementById('status-dashboard').innerText = "Modo Teste"; } else { document.getElementById('status-acesso').innerText = "Vence: " + currentUserData.date; document.getElementById('status-dashboard').innerText = "Vencimento: " + currentUserData.date; if(diff <= 5 && !dados.isMaster && dados.date !== 'Vital√≠cio') { document.getElementById('vencimento-alert').style.display = 'block'; document.getElementById('dias-restantes-alerta').innerText = diff < 0 ? 0 : diff; } } const btnAuto = document.getElementById('btn-autoresponder'); if (dados.cargo === 'Admin' || dados.cargo === 'User') { btnAuto.style.display = 'inline-flex'; } else { btnAuto.style.display = 'none'; } if(dados.isMaster) { document.getElementById('btn-open-admin').classList.remove('hidden'); document.getElementById('btn-open-admin-dash').classList.remove('hidden'); } if (dados.file && dados.file.url && dados.cargo !== 'Sub-Admin') { document.getElementById('file-download-card').style.display = 'flex'; document.getElementById('file-date').innerText = dados.file.time; document.getElementById('file-title').innerText = (dados.cargo === 'Teste') ? "Arquivo Teste (1h)" : "Arquivo Geral"; currentFileUrl = dados.file.url; document.getElementById('btn-download-file').style.display = 'block'; } else { document.getElementById('file-download-card').style.display = 'none'; } if(dados.message && dados.message.trim() !== "") { const savedMsg = localStorage.getItem('zapflow_last_msg_' + currentUserData.user); if (savedMsg !== dados.message) { document.getElementById('msg-text').innerText = dados.message; document.getElementById('modal-global-msg').classList.add('show'); } } carregarMeusClientes(); } else { msg.innerText = res.msg || "Dados incorretos."; localStorage.removeItem(SESSION_KEY); } } catch(e) { console.error(e); msg.innerText = "Erro ao conectar. Verifique internet."; } finally { btn.disabled = false; txt.style.display = 'block'; loader.style.display = 'none'; } }
    </script>
</body>
</html>
